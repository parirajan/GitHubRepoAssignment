Incident: 808-00cae2175c0460870
JIRA: https://jira.zollens-f6e3-2024-04
Issue: Silver images were built based on the provided HRBC April and June Golden AMI.
- Endure performance tests were failing.
- Services like Grafana were sending alerts due to high CPU load average for an extended period.

Analysis:
Further analyzing the issues, the following were observed:
1. The Kafka transactions fail to settle within 2.0s due to timeouts writing the messages to Azure Disk.
2. High CPU context issues like:
   a. Reschedule latency.
   b. Asynchronous I/O.
   c. High load average in random intervals.
   d. Significant write performance issues (EBS Volumes).

Based on the logs, the process that was stuck in the CPUs was related to the pid4 swapper. To further narrow down the issue,
1. This daemon was not found in significant instances.
2. Enabled sched_perf cpu config (insightful for CPU performance).
3. Analyzed the Kernel tuning and optimizations. This test enhanced the performance of the system significantly.

However, using the same Fedora base in April (Golden), this test result was not observed. Comparing the EBS write performance between April Golden images and HRBC April Golden images, the results were the same.
4. The CPU was showing the same latency issues around blocked journals.
5. Still, the processes are taking most CPU cycles.

Based on the above, there was a clear indication that there was a foundational change in the kernel that was contributing to this issue.
- Compared the Kernel Versions: The Silver image with HRBC June Golden AMI and HRBC April Golden images were same.
- Differences in journalctl daemon:
   a. Time change.
   b. Journal changes.
   c. Inodes.

This is severe as changes will be updated related security patches.
- Compared the kernel parameters, when compared between HRBC April Golden and June Golden AMI, we noticed the following arguments added by systemd.journal.flush:
   a. ForwardToConsole.
   b. Console.

Reviewed the release notes: https://fedoraproject.org/wiki/Notices/Attachment: June2022/204231.pd for any specific details around the above change and could not find any relevant information.

Note: Forwarding is performed synchronously within the journal, and may significantly affect its performance. This is particularly relevant when using ForwardToConsoles=yes in cloud environments, where the console is often a slow, virtual output. Since Journal is used as a logger by many services, enabling journal forwarding to a virtual/hung console will block journalctl. This can have a cascading effect resulting in any services synchronously logging to the blocked journal also being blocked. Unless actively debugging, it is advisable to setup a journalctl - follow style service redirected to the console instead of ForwardToConsoles=yes, for production use.

Solution:
1. Rebuilt the Silver images built on both the HRBC June Golden Image and updated the build with the same updates and tested with standard Fedora Performance test and did not see any of the above-discussed errors.
2. Request to have the latest Golden image from Intel Kernel Repo and proceed to run the same tests for identifying the root causes.
   a. If there are kernel configuration changes, we can get notified via the HRBC AMI release notes and the Fedora Kernel Mailing List.
   b. Once prepared, provide basic stress test results on the Golden AMIs released on regular intervals.
