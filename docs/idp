stages:
  - update_ami_west
  - update_ami_east

variables:
  AWS_ACCESS_KEY_ID: "<your-access-key-id>"
  AWS_SECRET_ACCESS_KEY: "<your-secret-access-key>"

before_script:
  - |
    function update_launch_template_with_latest_ami() {
        local REGION=$1
        local ASG_NAME=$2
        local AMI_NAME_PREFIX=$3

        echo "Updating Launch Template for ASG: ${ASG_NAME} in region: ${REGION} with the latest private AMI matching prefix: ${AMI_NAME_PREFIX}"

        # Derive the Launch Template name and version from the ASG
        LAUNCH_TEMPLATE_NAME=$(aws autoscaling describe-auto-scaling-groups \
            --region ${REGION} \
            --auto-scaling-group-names ${ASG_NAME} \
            --query "AutoScalingGroups[0].LaunchTemplate.LaunchTemplateName" \
            --output text)

        LAUNCH_TEMPLATE_VERSION=$(aws autoscaling describe-auto-scaling-groups \
            --region ${REGION} \
            --auto-scaling-group-names ${ASG_NAME} \
            --query "AutoScalingGroups[0].LaunchTemplate.Version" \
            --output text)

        if [ -z "$LAUNCH_TEMPLATE_NAME" ]; then
            echo "No Launch Template found for ASG: ${ASG_NAME} in region: ${REGION}"
            exit 1
        fi

        echo "Launch Template Name: ${LAUNCH_TEMPLATE_NAME}"
        echo "Launch Template Version: ${LAUNCH_TEMPLATE_VERSION}"

        # Fetch the latest private AMI ID based on the AMI name prefix
        LATEST_AMI_ID=$(aws ec2 describe-images \
            --region ${REGION} \
            --filters "Name=name,Values=${AMI_NAME_PREFIX}*" \
                      "Name=is-public,Values=false" \
            --query "Images | sort_by(@, &CreationDate)[-1].ImageId" \
            --output text)

        if [ -z "$LATEST_AMI_ID" ]; then
            echo "No private AMI found with the prefix: ${AMI_NAME_PREFIX} in region: ${REGION}"
            exit 1
        fi

        echo "Latest private AMI ID in ${REGION}: ${LATEST_AMI_ID}"

        # Create a new version of the launch template with the latest AMI ID
        aws ec2 create-launch-template-version \
            --region ${REGION} \
            --launch-template-name ${LAUNCH_TEMPLATE_NAME} \
            --version-description "Updated to latest private AMI with prefix '${AMI_NAME_PREFIX}'" \
            --source-version ${LAUNCH_TEMPLATE_VERSION} \
            --launch-template-data "{\"ImageId\":\"${LATEST_AMI_ID}\"}"

        # Optionally, make the new version the default version
        NEW_VERSION=$(aws ec2 describe-launch-template-versions \
            --region ${REGION} \
            --launch-template-name ${LAUNCH_TEMPLATE_NAME} \
            --query "LaunchTemplateVersions[-1].VersionNumber" \
            --output text)

        aws ec2 modify-launch-template \
            --region ${REGION} \
            --launch-template-name ${LAUNCH_TEMPLATE_NAME} \
            --default-version ${NEW_VERSION}

        echo "Launch Template ${LAUNCH_TEMPLATE_NAME} in region ${REGION} updated to version ${NEW_VERSION} with AMI ${LATEST_AMI_ID}"
    }

update_ami_in_west:
  stage: update_ami_west
  script:
    - |
      for i in 1 2 3; do
        update_launch_template_with_latest_ami "us-west-1" "svc-us-west-1-${i}" "my-custom-ami-prefix"
      done

update_ami_in_east:
  stage: update_ami_east
  script:
    - |
      for i in 1 2 3; do
        update_launch_template_with_latest_ami "us-east-1" "svc-us-east-1-${i}" "my-custom-ami-prefix"
      done
