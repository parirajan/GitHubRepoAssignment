@startuml
allowmixing

skinparam rectangle {
    StrokeColor black
    Shadowing false
}

rectangle "Account-1" as Account1 {
    rectangle User {
        node "User" as User
    }

    rectangle "Reverse Proxy" as ReverseProxy1 {
        node "NGINX/Other (Account-1)" as Proxy1
    }

    rectangle "Service Discovery" as ServiceDiscovery {
        database "Consul" as Consul
    }

    rectangle "Web Application" as WebApp {
        rectangle "Region1" {
            node "Web App Node 1 (Healthy)" as AppNode1
            node "Web App Node 2 (Down)" as AppNode2
            node "Web App Node 3 (Down)" as AppNode3
        }
        rectangle "Region2" {
            node "Web App Node 4 (Down)" as AppNode4
            node "Web App Node 5 (Down)" as AppNode5
            node "Web App Node 6 (Down)" as AppNode6
        }
    }

    rectangle "Identity Provider (IDP)" as IDP {
        node "IDP Server" as IDPServer
    }
}

rectangle "Account-DMZ" as AccountDMZ {
    rectangle "Reverse Proxy" as ReverseProxyDMZ {
        node "NGINX/Other (DMZ)" as ProxyDMZ
    }
}

User --> ProxyDMZ : Sends request
ProxyDMZ --> IDPServer : IDP Authentication
IDPServer --> ProxyDMZ : Auth Response
ProxyDMZ --> Proxy1 : Forward request\n+ Sticky Session
Proxy1 --> Consul : Resolves healthy nodes
Consul --> Proxy1 : Returns healthy node (Node 1)
Proxy1 --> AppNode1 : Proxies request\n+ Custom Headers

note right of AppNode2 : Other Nodes\nare marked down
@enduml
