@startuml
!define USERCOLOR #00FF00
!define GITLABCOLOR #FFFF00
!define RUNNERCOLOR #FC6D26
!define IAMCOLOR #8B0000
!define VAULTCOLOR #FF0000

' Setting background and border colors for participants
skinparam ParticipantBackgroundColor AWSCOLOR
skinparam ParticipantBorderColor AWSCOLOR
skinparam ParticipantBackgroundColor<<user>> USERCOLOR
skinparam ParticipantBorderColor<<user>> USERCOLOR
skinparam ParticipantBackgroundColor<<gitlab>> GITLABCOLOR
skinparam ParticipantBorderColor<<gitlab>> GITLABCOLOR
skinparam ParticipantBackgroundColor<<runner>> RUNNERCOLOR
skinparam ParticipantBorderColor<<runner>> RUNNERCOLOR
skinparam ParticipantBackgroundColor<<iam>> IAMCOLOR
skinparam ParticipantBorderColor<<iam>> IAMCOLOR
skinparam ParticipantBackgroundColor<<vault>> VAULTCOLOR
skinparam ParticipantBorderColor<<vault>> VAULTCOLOR

' Define the boundary for AWS accounts
skinparam BoxPadding 10

box "AppCore AWS Account" #LightBlue
participant User <<user>>
participant "GitLab Repository" as Repo <<gitlab>>
participant "GitLab Pipeline" as GitLab <<gitlab>>
end box

box "Vault AWS Account" #LightGreen
participant "GitLab Runner\nwith vaultadmin IAM role" as Runner <<runner>>
participant "AWS IAM\n(vaultadmin role)" as IAM <<iam>>
participant Vault <<vault>>
end box

User -> Repo : Commits code to branch
activate Repo

User -> Repo : Creates merge request (MR)
Repo -> User : MR reviewed

User -> Repo : Merges MR into main
deactivate Repo

Repo -> GitLab : Triggers pipeline
activate GitLab

GitLab -> Runner : Starts runner
activate Runner

Runner -> IAM : Assumes vaultadmin IAM role
activate IAM

IAM -> Vault : Auth via AWS IAM auth method\nwith admin policy
activate Vault

Vault --> IAM : Auth successful
deactivate Vault

Runner -> Vault : Perform admin tasks
activate Vault

Vault --> Runner : Tasks completed
deactivate Vault

Runner --> GitLab : Pipeline job complete
deactivate Runner

GitLab --> User : Pipeline completed
deactivate GitLab
@enduml
