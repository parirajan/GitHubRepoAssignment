@startuml
allowmixing

skinparam rectangle {
    StrokeColor black
    Shadowing false
}

rectangle User {
    node "User" as User
}

rectangle "Reverse Proxy" as ReverseProxy {
    node "NGINX/Other" as Proxy
}

rectangle "Service Discovery" as ServiceDiscovery {
    database "Consul" as Consul
}

rectangle "Web Application" as WebApp {
    node "Web App Node 1 (Healthy)" as AppNode1
    node "Web App Node 2 (Down)" as AppNode2
    node "Web App Node 3 (Down)" as AppNode3
    node "Web App Node 4 (Down)" as AppNode4
    node "Web App Node 5 (Down)" as AppNode5
    node "Web App Node 6 (Down)" as AppNode6
}

rectangle "Identity Provider (IDP)" as IDP {
    node "IDP Server" as IDPServer
}

User --> Proxy : Sends request
Proxy --> IDPServer : IDP Authentication
IDPServer --> Proxy : Auth Response
Proxy --> Consul : Resolves healthy nodes
Consul --> Proxy : Returns healthy node (Node 1)
Proxy --> AppNode1 : Proxies request\n+ Custom Headers

note right of AppNode2 : Other Nodes\nare marked down
@enduml
