@startuml
title Day 0 Setup: RDS PostgreSQL IAM Authentication with GitLab CI/CD (Assume Role Only)

skinparam participant {
    BackgroundColor<<Pipeline>> LightSkyBlue
    BackgroundColor<<Terraform>> LightYellow
    BackgroundColor<<IAM>> LightPink
    BackgroundColor<<RDS>> LightGreen
    BorderColor Black
    FontSize 14
    FontColor Black
}

actor "GitLab CI/CD Pipeline" as Pipeline <<Pipeline>>
participant "Terraform" as TF <<Terraform>>
participant "AWS IAM" as IAM <<IAM>>
participant "Amazon RDS (PostgreSQL)" as RDS <<RDS>>

Pipeline -> TF : Run Terraform Configuration
TF -> IAM : Assume IAM Role with `rds-db:connect` Policy
IAM --> TF : Temporary IAM Credentials (Access Key, Secret Key, Session Token)

TF -> RDS : Modify RDS Cluster/Instance\nEnable IAM Authentication
RDS -> TF : IAM Database Authentication Enabled

Pipeline -> RDS : Connect to RDS using Assumed Role
Pipeline -> RDS : CREATE ROLE iam_role LOGIN;\nGRANT rds_iam TO iam_role;
Pipeline -> RDS : GRANT SELECT, INSERT\nON database_name TO iam_role;

@enduml
